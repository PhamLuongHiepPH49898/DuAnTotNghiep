<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f0f4f8;
            font-family: 'Segoe UI', sans-serif;
        }

        .payment-container {
            max-width: 550px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        h3 {
            color: #2c6e91;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-label {
            font-weight: 600;
            color: #333;
        }

        .qr-container {
            display: none;
            margin-top: 20px;
            text-align: center;
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 10px;
        }

        .qr-container img {
            max-width: 180px;
            border-radius: 8px;
        }

        .btn-pay {
            background: linear-gradient(to right, #4ca1af, #2c6e91);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-pay:hover {
            background: linear-gradient(to right, #3d8d99, #23566f);
        }

        .fw-bold.text-danger.fs-5 {
            font-size: 1.4rem !important;
            text-align: center;
        }

        .countdown {
            font-size: 18px;
            font-weight: bold;
            color: red;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="payment-container">
    <h3>THANH TOÁN ĐẶT SÂN</h3>

    <div class="mb-4">
        <label class="form-label">Tổng tiền cần thanh toán:</label>
        <p class="fw-bold text-danger fs-5" id="totalPrice">0</p>
    </div>

    <form id="paymentForm">
        <input type="hidden" name="idLichDatSan" id="idLichDatSan" th:value="${idLichDatSan}" />
        <input type="hidden" id="idTaiKhoan" th:value="${idTaiKhoan}" />

        <div class="mb-3">
            <label class="form-label" for="phuongThucSelect">Phương thức thanh toán</label>
            <select id="phuongThucSelect" name="idPhuongThucThanhToan" class="form-select" required>
                <option th:each="pt : ${dsPhuongThuc}"
                        th:value="${pt.idPhuongThucThanhToan}"
                        th:text="${pt.tenPhuongThucThanhToan}"></option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label" for="taiKhoanNganHang">Tài khoản ngân hàng / ví điện tử</label>
            <select id="taiKhoanNganHang" class="form-select" required>
                <option value="">Chọn tài khoản ngân hàng</option>
                <option th:each="tk : ${dsTaiKhoanNganHang}"
                        th:value="${tk.soTaiKhoan}"
                        th:data-bank="${tk.bankCode}"
                        th:data-account-name="${tk.chuTaiKhoan}"
                        th:text="${tk.tenNganHang + ' - ' + tk.soTaiKhoan}">
                </option>
            </select>
        </div>

        <div id="qrContainer" class="qr-container">
            <img id="qrImage" src="" alt="QR VietQR">
            <p class="mt-2 fw-bold">Quét mã để thanh toán</p>
        </div>

        <div class="countdown">
            Hết hạn trong: <span id="timer">05:00</span>
        </div>

        <a href="/ve-trang-chu" class="btn btn-pay w-100 mt-4 text-center" style="text-decoration: none;">Tạm ngừng thanh toán</a>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const bookingList = JSON.parse(localStorage.getItem("chiTietDatLichList")) || [];
        const total = bookingList.reduce((sum, item) => sum + Number(item.price), 0);
        document.getElementById("totalPrice").innerText = total.toLocaleString('vi-VN');

        const taiKhoanSelect = document.getElementById('taiKhoanNganHang');
        taiKhoanSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const bank = selectedOption.getAttribute('data-bank');
            const accountNumber = selectedOption.value;
            const accountName = selectedOption.getAttribute('data-account-name');
            const idTaiKhoan = document.getElementById('idTaiKhoan').value;

            if (bank && accountNumber && accountName && idTaiKhoan) {
                const qrUrl = `https://img.vietqr.io/image/${bank}-${accountNumber}-qronly.png?amount=${total}&accountName=${accountName}&addInfo=SAMBA${idTaiKhoan}`;
                document.getElementById('qrImage').src = qrUrl;
                document.getElementById('qrContainer').style.display = 'block';
            } else {
                document.getElementById('qrContainer').style.display = 'none';
            }
        });

        // COUNTDOWN 5 PHÚT
        let timeLeft = 300;
        const timerEl = document.getElementById("timer");

        const countdown = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timerEl.textContent = `${minutes}:${seconds}`;
            timeLeft--;

            if (timeLeft < 0) {
                clearInterval(countdown);
                window.location.href = "/ve-trang-chu";
            }
        }, 1000);
    });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thống kê doanh thu theo sân</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

    <style>
        :root{
            --sidebar-w: 260px; /* chiều rộng sidebar cố định */
            --header-h: 60px;   /* chiều cao header cố định  */
        }

        body{
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ===== Sidebar cố định (desktop) ===== */
        .sidebar{
            background:#fff;
            color:#1B1E21;
            height:100vh;
            position:fixed;
            top:0;
            left:0;
            width:var(--sidebar-w);
            padding-top:var(--header-h);
            z-index:1030;
            box-shadow:2px 0 5px rgba(0,0,0,.1);
        }
        .sidebar .nav-link{ color:#1B1E21; padding:12px 20px; transition:.2s }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active{ background:rgba(0,0,0,.03); padding-left:26px }

        /* Logo vùng header của sidebar */
        .sidebar-logo{
            position:fixed;
            top:0; left:0;
            width:var(--sidebar-w);
            height:var(--header-h);
            background:#fff;
            border-bottom:1px solid #dee2e6;
            display:flex; align-items:center; justify-content:center;
            z-index:1040; color:#595555;
            gap:8px;
        }
        .sidebar-logo img{ max-height:40px; object-fit:contain }

        /* ===== Header cố định ===== */
        header{
            position:fixed;
            top:0;
            left:var(--sidebar-w);   /* KHỚP chiều rộng sidebar */
            right:0;
            height:var(--header-h);
            background:#fff;
            color:#333;
            display:flex; align-items:center; justify-content:flex-end;
            padding:0 20px;
            border-bottom:1px solid #dee2e6;
            z-index:1020;
        }

        /* ===== ĐẨY TOÀN TRANG sang phải để không bị che ===== */
        body.with-sidebar{ padding-left:var(--sidebar-w); }

        /* Vùng nội dung chính (đừng set margin-left nữa) */
        .main-wrapper{ margin-left:0; padding: calc(var(--header-h) + 20px) 20px 40px; }

        /* ===== Mobile: ẩn sidebar cố định, dùng offcanvas ===== */
        @media (max-width:768px){
            .sidebar, .sidebar-logo, header{ display:none; }
            body.with-sidebar{ padding-left:0; }
            .main-wrapper{ padding:90px 16px 32px; }
        }

        /* Kích thước biểu đồ gọn đẹp (desktop 420px, mobile 300px) */
        .chart-wrap{ height:420px; position:relative; }
        @media (max-width:991.98px){ .chart-wrap{ height:300px; } }
    </style>
</head>
<body class="with-sidebar">

<!-- Logo (desktop) -->
<div class="sidebar-logo d-none d-md-flex">
    <img src="/image/logo.png" alt="Logo"><h5 class="m-0">SAMBA</h5>
</div>

<!-- Sidebar (desktop) -->
<nav class="sidebar d-none d-md-block">
    <ul class="nav flex-column mt-3">
        <li class="nav-item"><a class="nav-link" href="/quan-ly-san"><i class="bi bi-card-list"></i> Quản lý sân</a></li>
        <li class="nav-item"><a class="nav-link" href="/quan-ly-gia-theo-khung-gio"><i class="bi bi-card-list"></i> Quản lý giá theo khung giờ</a></li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-calendar-event"></i> Quản lý đặt sân</a>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/quan-ly-lich-dat">Quản lý lịch đặt</a></li>
                <li><a class="dropdown-item" href="/duyet-huy-lich">Duyệt/Hủy lịch</a></li>
            </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/quan-ly-hoan-tien"><i class="bi bi-arrow-counterclockwise"></i> Quản lý hoàn tiền</a></li>
        <li class="nav-item"><a class="nav-link" href="/quan-ly-thanh-toan"><i class="bi bi-wallet2"></i> Quản lý thanh toán</a></li>
        <li class="nav-item"><a class="nav-link" href="/quan-ly-nguoi-dung"><i class="bi bi-people"></i> Quản lý người dùng</a></li>
        <li class="nav-item"><a class="nav-link active" href="/thongke/doanhthu"><i class="bi bi-bar-chart"></i> Quản lý thống kê</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/ve-trang-chu}"><i class="bi bi-house-door"></i> Quay lại Trang chủ</a></li>
    </ul>
</nav>

<!-- Header (desktop) -->
<header class="d-none d-md-flex">
    <div class="dropdown">
        <a class="d-flex align-items-center dropdown-toggle text-decoration-none text-dark" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-2 fs-5 text-dark"></i>
            <span class="fw-semibold" th:text="${hoTen}">Admin</span>
        </a>
        <ul class="dropdown-menu">
            <li>
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="dropdown-item text-dark">Đăng xuất</button>
                </form>
            </li>
        </ul>
    </div>
</header>

<!-- Navbar mobile + offcanvas -->
<nav class="navbar navbar-light bg-white fixed-top d-md-none border-bottom shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="/image/logo.png" alt="Logo" style="height:100%;max-height:60px;object-fit:contain;margin-right:10px;">
            <span class="fw-semibold text-dark" th:text="${hoTen}">Admin</span>
        </div>
        <button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
            <i class="bi bi-list"></i>
        </button>
    </div>
</nav>

<div class="offcanvas offcanvas-start white" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-body">
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="/quan-ly-san">Quản lý sân</a></li>
            <li class="nav-item"><a class="nav-link" href="/quan-ly-gia-theo-khung-gio">Quản lý giá theo khung giờ</a></li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Quản lý đặt sân</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="/quan-ly-lich-dat">Quản lý lịch đặt</a></li>
                    <li><a class="dropdown-item" href="/duyet-huy-lich">Duyệt/Hủy lịch</a></li>
                </ul>
            </li>
            <li class="nav-item"><a class="nav-link" href="/quan-ly-hoan-tien">Quản lý hoàn tiền</a></li>
            <li class="nav-item"><a class="nav-link" href="/quan-ly-thanh-toan">Quản lý thanh toán</a></li>
            <li class="nav-item"><a class="nav-link" href="/quan-ly-nguoi-dung">Quản lý người dùng</a></li>
            <li class="nav-item"><a class="nav-link" href="/thongke/doanhthu">Quản lý thống kê</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/ve-trang-chu}">Quay lại Trang chủ</a></li>
        </ul>
    </div>
</div>

<!-- ========== NỘI DUNG ========= -->
<main class="main-wrapper">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="m-0">Thống kê doanh thu theo sân</h3>
        <form class="d-flex gap-2" method="get" th:action="@{/thongke/doanhthu}">
            <input type="month" class="form-control" name="monthYear" th:value="${monthYear}">
            <button class="btn btn-primary"><i class="bi bi-search"></i> Lọc</button>
        </form>
    </div>

    <div class="row g-4">
        <!-- BẢNG -->
        <div class="col-lg-7">
            <div class="card p-3 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Bảng doanh thu (tháng [[${month}]]/[[${year}]])</h5>
                    <span class="badge bg-success fs-6">
            Tổng:
            <span th:text="${#numbers.formatDecimal(total?:0, 0, 'POINT', 0, 'POINT')}"></span> ₫
          </span>
                </div>

                <div class="table-responsive mt-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Sân</th>
                            <th class="text-end">Lượt đặt</th>
                            <th class="text-end">Doanh thu (₫)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="row, st : ${list}">
                            <td th:text="${st.index + 1}">1</td>
                            <td th:text="${row.tenSan}">Sân A</td>
                            <td class="text-end" th:text="${row.soLuotDat}">0</td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(row.tongDoanhThu?:0, 0, 'POINT', 0, 'POINT')}">0</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(list)}">
                            <td colspan="4" class="text-center text-muted">Không có dữ liệu</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BIỂU ĐỒ -->
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header fw-bold">Biểu đồ doanh thu</div>
                <div class="card-body">
                    <div class="chart-wrap">
                        <canvas id="revChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- VẼ BIỂU ĐỒ -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const labels = /*[[${labels}]]*/ [];
        const values = /*[[${values}]]*/ [];

        if (!labels || labels.length === 0) {
            const c = document.getElementById('revChart');
            if (c) c.replaceWith(document.createTextNode('Không có dữ liệu để vẽ biểu đồ'));
            return;
        }

        const dataNums = values.map(v => typeof v === 'string' ? Number(v) : v);
        const ctx = document.getElementById('revChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label: 'Doanh thu (đ)', data: dataNums, borderWidth: 1 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: v => Number(v).toLocaleString('vi-VN') }
                    }
                },
                plugins: {
                    tooltip: { callbacks: { label: ctx => ctx.raw.toLocaleString('vi-VN') + ' đ' } }
                }
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
